#!/usr/bin/env python3
"""
PrestaShop Security Scanner
Author: Paul Deborah Ginikachi
Date: January 17, 2026
Description: Custom vulnerability scanner for PrestaShop installations
"""

import requests
import sys
import json
from datetime import datetime
from urllib.parse import urljoin

class Colors:
    """ANSI color codes for terminal output"""
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'

class PrestaShopScanner:
    def __init__(self, target_url):
        self.target_url = target_url.rstrip('/')
        self.vulnerabilities = []
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'PrestaShop-Security-Scanner/1.0'
        })
    
    def print_banner(self):
        """Print scanner banner"""
        print(f"{Colors.CYAN}{Colors.BOLD}")
        print("=" * 60)
        print(" PrestaShop Security Scanner v1.0")
        print(" Author: Paul Deborah Ginikachi")
        print("=" * 60)
        print(f"{Colors.END}")
        print(f"Target: {Colors.YELLOW}{self.target_url}{Colors.END}")
        print(f"Scan started at: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print()
    
    def make_request(self, path, method='GET'):
        """Make HTTP request with error handling"""
        try:
            url = urljoin(self.target_url, path)
            if method == 'GET':
                response = self.session.get(url, timeout=10, allow_redirects=False)
            else:
                response = self.session.head(url, timeout=10, allow_redirects=False)
            return response
        except requests.RequestException as e:
            print(f"{Colors.RED}[!] Error accessing {url}: {str(e)}{Colors.END}")
            return None
    
    def add_vulnerability(self, severity, title, description, evidence):
        """Add vulnerability to results"""
        self.vulnerabilities.append({
            'severity': severity,
            'title': title,
            'description': description,
            'evidence': evidence,
            'timestamp': datetime.now().isoformat()
        })
    
    def test_version_disclosure(self):
        """Test for version information disclosure"""
        print(f"{Colors.BLUE}[*] Testing for version disclosure...{Colors.END}")
        
        paths = [
            '/CHANGELOG.txt',
            '/docs/CHANGELOG.txt',
            '/VERSION',
            '/readme.md',
        ]
        
        found = False
        for path in paths:
            response = self.make_request(path)
            if response and response.status_code == 200:
                print(f"{Colors.YELLOW}[!] Version file found: {path}{Colors.END}")
                found = True
        
        if not found:
            print(f"{Colors.GREEN}[+] No obvious version disclosure found{Colors.END}")
    
    def test_directory_listing(self):
        """Test for directory listing vulnerabilities"""
        print(f"{Colors.BLUE}[*] Testing for directory listing...{Colors.END}")
        
        paths = [
            '/upload/',
            '/img/',
            '/download/',
            '/modules/',
            '/themes/'
        ]
        
        found = False
        for path in paths:
            response = self.make_request(path)
            if response and response.status_code == 200:
                if 'Index of' in response.text:
                    print(f"{Colors.RED}[!] Directory listing enabled: {path}{Colors.END}")
                    found = True
        
        if not found:
            print(f"{Colors.GREEN}[+] No directory listing vulnerabilities{Colors.END}")
    
    def test_sql_injection(self):
        """Basic SQL injection testing"""
        print(f"{Colors.BLUE}[*] Testing for SQL injection...{Colors.END}")
        
        payloads = [
            "1' OR '1'='1",
            "1' UNION SELECT NULL--",
            "1' AND 1=1--"
        ]
        
        test_url = f"{self.target_url}/index.php?id_product="
        
        for payload in payloads:
            response = self.make_request(f"index.php?id_product={payload}")
            if response and 'sql' in response.text.lower():
                print(f"{Colors.RED}[!] Possible SQL injection found{Colors.END}")
                return
        
        print(f"{Colors.GREEN}[+] No obvious SQL injection found{Colors.END}")
    
    def test_xss(self):
        """Basic XSS testing"""
        print(f"{Colors.BLUE}[*] Testing for XSS vulnerabilities...{Colors.END}")
        
        payloads = [
            "<script>alert('XSS')</script>",
            "<img src=x onerror=alert(1)>"
        ]
        
        test_url = f"{self.target_url}/search?search_query="
        
        for payload in payloads:
            response = self.make_request(f"search?search_query={payload}")
            if response and payload in response.text:
                print(f"{Colors.RED}[!] Possible XSS vulnerability found{Colors.END}")
                return
        
        print(f"{Colors.GREEN}[+] No obvious XSS vulnerabilities found{Colors.END}")
    
    def test_admin_panel(self):
        """Attempt to locate admin panel"""
        print(f"{Colors.BLUE}[*] Attempting to locate admin panel...{Colors.END}")
        
        common_paths = [
            '/admin',
            '/admin-dev',
            '/administration',
            '/backend',
            '/manage',
            '/admin123'
        ]
        
        for path in common_paths:
            response = self.make_request(path)
            if response and response.status_code == 200:
                print(f"{Colors.YELLOW}[!] Admin panel found at: {path}{Colors.END}")
                return
        
        print(f"{Colors.GREEN}[+] Admin panel not found at common locations{Colors.END}")
    
    def test_file_upload(self):
        """Test file upload security"""
        print(f"{Colors.BLUE}[*] Testing file upload security...{Colors.END}")
        
        # Check for upload directories
        upload_paths = ['/upload/', '/uploads/', '/files/']
        
        for path in upload_paths:
            response = self.make_request(path)
            if response and response.status_code == 200:
                print(f"{Colors.YELLOW}[!] Upload directory accessible: {path}{Colors.END}")
    
    def check_security_headers(self):
        """Check for security headers"""
        print(f"{Colors.BLUE}[*] Checking security headers...{Colors.END}")
        
        response = self.make_request('/')
        if not response:
            return
        
        headers = response.headers
        
        security_headers = {
            'X-Frame-Options': 'Clickjacking protection',
            'X-Content-Type-Options': 'MIME type sniffing protection',
            'Strict-Transport-Security': 'HTTPS enforcement',
            'Content-Security-Policy': 'XSS protection',
            'X-XSS-Protection': 'XSS filter'
        }
        
        for header, description in security_headers.items():
            if header not in headers:
                print(f"{Colors.YELLOW}[!] Missing {header} header ({description}){Colors.END}")
                self.add_vulnerability(
                    'LOW',
                    f'Missing Security Header - {header}',
                    f'Missing {header} header ({description})',
                    'Header not found in response'
                )
            else:
                print(f"{Colors.GREEN}[+] {header}: {headers[header]}{Colors.END}")
    
    def check_ssl_tls(self):
        """Check SSL/TLS configuration"""
        print(f"{Colors.BLUE}[*] Checking SSL/TLS configuration...{Colors.END}")
        
        if self.target_url.startswith('https://'):
            print(f"{Colors.GREEN}[+] Site uses HTTPS{Colors.END}")
        else:
            print(f"{Colors.RED}[HIGH] SSL/TLS Configuration: Site does not enforce HTTPS{Colors.END}")
            self.add_vulnerability(
                'HIGH',
                'SSL/TLS Configuration',
                'Site does not enforce HTTPS',
                f'Site accessible via HTTP: {self.target_url}'
            )
    
    def generate_report(self):
        """Generate scan report"""
        print()
        print(f"{Colors.CYAN}{Colors.BOLD}{'=' * 60}{Colors.END}")
        print(f"{Colors.CYAN}{Colors.BOLD}SCAN SUMMARY{Colors.END}")
        print(f"{Colors.CYAN}{Colors.BOLD}{'=' * 60}{Colors.END}")
        
        # Count vulnerabilities by severity
        severity_counts = {
            'CRITICAL': len([v for v in self.vulnerabilities if v['severity'] == 'CRITICAL']),
            'HIGH': len([v for v in self.vulnerabilities if v['severity'] == 'HIGH']),
            'MEDIUM': len([v for v in self.vulnerabilities if v['severity'] == 'MEDIUM']),
            'LOW': len([v for v in self.vulnerabilities if v['severity'] == 'LOW'])
        }
        
        total = sum(severity_counts.values())
        
        print(f"\nTotal Vulnerabilities Found: {total}")
        print(f"  - Critical: {severity_counts['CRITICAL']}")
        print(f"  - High: {severity_counts['HIGH']}")
        print(f"  - Medium: {severity_counts['MEDIUM']}")
        print(f"  - Low: {severity_counts['LOW']}")
        
        if self.vulnerabilities:
            print(f"\n{Colors.YELLOW}DETAILED FINDINGS:{Colors.END}")
            for i, vuln in enumerate(self.vulnerabilities, 1):
                severity_color = {
                    'CRITICAL': Colors.RED,
                    'HIGH': Colors.RED,
                    'MEDIUM': Colors.YELLOW,
                    'LOW': Colors.YELLOW
                }.get(vuln['severity'], Colors.END)
                
                print(f"\n[{i}] {vuln['title']} - {severity_color}{vuln['severity']}{Colors.END}")
                print(f"    Description: {vuln['description']}")
                print(f"    Evidence: {vuln['evidence']}")
                print(f"    Timestamp: {vuln['timestamp']}")
        
        # Save to JSON
        report_file = f"prestashop_scan_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(report_file, 'w') as f:
            json.dump({
                'target': self.target_url,
                'scan_date': datetime.now().isoformat(),
                'total_vulnerabilities': total,
                'severity_breakdown': severity_counts,
                'vulnerabilities': self.vulnerabilities
            }, f, indent=2)
        
        print(f"\n{Colors.GREEN}[+] Report saved to: {report_file}{Colors.END}")
        print(f"{Colors.CYAN}{Colors.BOLD}{'=' * 60}{Colors.END}\n")
    
    def run(self):
        """Run all security tests"""
        self.print_banner()
        
        print(f"{Colors.YELLOW}[!] Make sure you have permission to scan this target!{Colors.END}\n")
        
        # Run tests
        self.test_version_disclosure()
        self.test_directory_listing()
        self.test_sql_injection()
        self.test_xss()
        self.test_admin_panel()
        self.test_file_upload()
        self.check_security_headers()
        self.check_ssl_tls()
        
        # Generate report
        self.generate_report()

def main():
    if len(sys.argv) < 2:
        print(f"{Colors.RED}Usage: python3 prestashop_scanner.py <target_url>{Colors.END}")
        print(f"Example: python3 prestashop_scanner.py http://localhost:8080")
        sys.exit(1)
    
    target_url = sys.argv[1]
    scanner = PrestaShopScanner(target_url)
    scanner.run()

if __name__ == '__main__':
    main()
