#!/bin/bash
#################################################################
# PrestaShop Automated Backup Script
# Author: Paul Deborah Ginikachi
# Date: January 17, 2026
# Description: Automated backup of PrestaShop database and files
#################################################################

# Configuration
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/opt/prestashop-backups"
RETENTION_DAYS=7

# Docker Configuration
DOCKER_CONTAINER="prestashop"
DOCKER_DB_CONTAINER="prestashop_mysql"
DB_NAME="prestashop"
DB_USER="prestashop"
DB_PASS="prestashop_password"

# File paths
DB_BACKUP="$BACKUP_DIR/db_${DATE}.sql"
FILES_BACKUP="$BACKUP_DIR/files_${DATE}.tar.gz"
LOG_FILE="$BACKUP_DIR/backup.log"

#################################################################
# Functions
#################################################################

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

check_dependencies() {
    log_message "Checking dependencies..."
    
    if ! command -v docker &> /dev/null; then
        log_message "ERROR: Docker is not installed"
        exit 1
    fi
    
    log_message "Dependencies OK"
}

create_backup_dir() {
    if [ ! -d "$BACKUP_DIR" ]; then
        log_message "Creating backup directory: $BACKUP_DIR"
        sudo mkdir -p "$BACKUP_DIR"
        sudo chmod 755 "$BACKUP_DIR"
    fi
}

backup_database() {
    log_message "Starting database backup..."
    
    # Execute mysqldump inside Docker container
    sudo docker exec "$DOCKER_DB_CONTAINER" mysqldump \
        -u"$DB_USER" \
        -p"$DB_PASS" \
        "$DB_NAME" > "$DB_BACKUP" 2>> "$LOG_FILE"
    
    if [ $? -eq 0 ]; then
        DB_SIZE=$(du -h "$DB_BACKUP" | cut -f1)
        log_message "Database backup completed: $DB_BACKUP ($DB_SIZE)"
    else
        log_message "ERROR: Database backup failed"
        exit 1
    fi
}

backup_files() {
    log_message "Starting file backup..."
    
    # Backup PrestaShop files from Docker container
    sudo docker exec "$DOCKER_CONTAINER" tar czf - /var/www/html \
        --exclude='var/cache/*' \
        --exclude='var/logs/*' > "$FILES_BACKUP" 2>> "$LOG_FILE"
    
    if [ $? -eq 0 ]; then
        FILES_SIZE=$(du -h "$FILES_BACKUP" | cut -f1)
        log_message "Files backup completed: $FILES_BACKUP ($FILES_SIZE)"
    else
        log_message "ERROR: Files backup failed"
        exit 1
    fi
}

cleanup_old_backups() {
    log_message "Cleaning up backups older than $RETENTION_DAYS days..."
    
    find "$BACKUP_DIR" -name "db_*.sql" -mtime +$RETENTION_DAYS -delete 2>> "$LOG_FILE"
    find "$BACKUP_DIR" -name "files_*.tar.gz" -mtime +$RETENTION_DAYS -delete 2>> "$LOG_FILE"
    
    log_message "Cleanup completed"
}

verify_backups() {
    log_message "Verifying backups..."
    
    # Check if backup files exist and have size > 0
    if [ -s "$DB_BACKUP" ] && [ -s "$FILES_BACKUP" ]; then
        log_message "Backup verification: PASSED"
        return 0
    else
        log_message "Backup verification: FAILED"
        return 1
    fi
}

generate_report() {
    log_message "==================================="
    log_message "Backup Summary"
    log_message "==================================="
    log_message "Date: $(date)"
    log_message "Database Backup: $DB_BACKUP"
    log_message "Files Backup: $FILES_BACKUP"
    log_message "Total Backups in Directory: $(ls -1 $BACKUP_DIR/*.sql 2>/dev/null | wc -l) DB, $(ls -1 $BACKUP_DIR/*.tar.gz 2>/dev/null | wc -l) Files"
    log_message "Disk Usage: $(du -sh $BACKUP_DIR | cut -f1)"
    log_message "==================================="
}

#################################################################
# Main Execution
#################################################################

main() {
    log_message "========================================="
    log_message "PrestaShop Backup Started"
    log_message "========================================="
    
    check_dependencies
    create_backup_dir
    backup_database
    backup_files
    verify_backups
    cleanup_old_backups
    generate_report
    
    log_message "========================================="
    log_message "PrestaShop Backup Completed Successfully"
    log_message "========================================="
}

# Run main function
main

# Exit with success
exit 0
